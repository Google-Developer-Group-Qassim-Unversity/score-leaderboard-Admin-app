name: Deploy Refactor Backend

on:
  push:
    branches: [ refactor ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e # stops the script if any command fails
          export PATH="$HOME/.local/bin:$PATH"
        
          echo "Running Deployment commands...ğŸš€"
          NAME="score-admin-refactor"
          TARGET_DIR=~/$NAME
          BRANCH=refactor
          REPO_URL="https://github.com/Google-Developer-Group-Qassim-Unversity/score-leaderboard-Admin-app.git"
          PORT=7501
          
          echo "Cloning new repository..."
          rm -rf "$TARGET_DIR"
          git clone --branch $BRANCH "$REPO_URL" "$TARGET_DIR"
          rm -rf $TARGET_DIR/Frontend
          mv $TARGET_DIR/Backend/* $TARGET_DIR
          rm -rf $TARGET_DIR/Backend
          echo "Deployment Complete âœ…."
          echo "==============================="
          
          echo "Running Build commands...ğŸš€"
          cd "$TARGET_DIR"
          
          if ! command -v uv >/dev/null 2>&1; then
              echo "â˜€ï¸ Installing uv..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
              source ~/.bashrc
          else
              echo "â˜€ï¸ Found uv at $(command -v uv)"
          fi
          
          echo "ğŸ“¦ setting up virtual environment and installing dependencies..."
          uv venv --clear -p python3.13 .venv
          source .venv/bin/activate
          uv pip install -q -r requirements.txt
          
          echo "ğŸ¥· setting up environment variables..."
          if [ -z ${{ secrets.DATABASE_URL  }} ]; then
              echo "â— DATABASE_URL is not set in secrets. Exiting..."
              exit 1
          fi
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          
          echo "Build Complete âœ…."
          echo "==============================="
          
          echo "ğŸš€ Starting application with pm2..."
          if ! command -v pm2 >/dev/null 2>&1; then
              echo "â— PM2 not Found"
              echo "install it with:  npm install pm2 -g"
              exit 1
          fi

          if pm2 restart $NAME; then
              echo "ğŸ’¾ process $NAME restarted successfully."
          else
              echo "ğŸ’¾ process $NAME not found creating new process..."
              pm2 start "uv run uvicorn app.main:app --port $PORT" --name $NAME --time
          fi
          pm2 save
          echo "Application is running on port $PORT âœ…."
          echo "==============================="
          
            