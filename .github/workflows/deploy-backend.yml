name: Deploy Refactor Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e # stops the script if any command fails
          export PATH="$HOME/.local/bin:$PATH"
        
          echo "Running Deployment commands...üöÄ"
          NAME="GDG-backend"
          TARGET_DIR=~/$NAME
          BRANCH=main
          REPO_URL="https://github.com/Google-Developer-Group-Qassim-Unversity/score-leaderboard-Admin-app.git"
          PORT=7501
          PM2_PATH="/home/ubuntu/.nvm/versions/node/v24.12.0/bin/"
          export PATH="$PM2_PATH:$PATH"
          
          echo "Cloning new repository..."
          rm -rf "$TARGET_DIR"
          git clone --branch $BRANCH "$REPO_URL" "$TARGET_DIR"
          rm -rf $TARGET_DIR/Frontend
          mv $TARGET_DIR/Backend/* $TARGET_DIR
          rm -rf $TARGET_DIR/Backend
          echo "Deployment Complete ‚úÖ."
          echo "==============================="
          
          echo "Running Build commands...üöÄ"
          cd "$TARGET_DIR"
          
          if ! command -v uv >/dev/null 2>&1; then
              echo "‚òÄÔ∏è Installing uv..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
              source ~/.bashrc
          else
              echo "‚òÄÔ∏è Found uv at $(command -v uv)"
          fi

          echo "ü•∑ setting up environment variables..."
          
          EQUIRED_VARS="DATABASE_URL JWT_SECRET GOOGLE_CLIENT_SECRET GOOGLE_CLIENT_ID"
          for VAR_NAME in $REQUIRED_VARS; do
              VALUE="${!VAR_NAME}"  
              
              if [ -z "$VALUE" ]; then
                  echo "‚ùó $VAR_NAME is not set (forwarding failed). Exiting..."
                  exit 1
              fi
              
              echo "$VAR_NAME=$VALUE" >> .env
          done
          echo "Secrets written to .env ‚úÖ"

          
          echo "üì¶ setting up virtual environment and installing dependencies..."
          uv venv --clear -p python3.13 .venv
          source .venv/bin/activate
          uv pip install -q -r requirements.txt
                    
          echo "Build Complete ‚úÖ."
          echo "==============================="
          
          echo "üöÄ Starting application with pm2..."
          if ! command -v pm2 >/dev/null 2>&1; then
              echo "‚ùó PM2 not Found"
              echo "install it with:  npm install pm2 -g"
              exit 1
          fi

          echo "üíæ creating proccess $NAME..."
          pm2 delete $NAME || true
          pm2 start "uv run uvicorn app.main:app --port $PORT --host 0.0.0.0" --name $NAME --time
          pm2 save
          echo "Application is running on port $PORT ‚úÖ."
          echo "==============================="
          
            
